# クリニックランキングサイト 運用ドキュメント

最終更新日: 2025年7月17日

## 1. サーバー起動手順書

### 基本的な起動方法

```bash
# プロジェクトディレクトリに移動
cd /Users/hattaryoga/Desktop/kiro_サイト出し分け/Claude-Code-Communication

# サーバーを起動（推奨）
python3 start-server.py
```

### バックグラウンドでの起動

```bash
# ログファイルに出力しながらバックグラウンドで起動
nohup python3 start-server.py > ./logs/server.log 2>&1 &
```

### 起動確認

```bash
# ポート8000が使用されているか確認
lsof -i :8000

# サーバーにアクセスできるか確認
curl -I http://localhost:8000
```

### 起動時の出力例

```
🚀 サーバーを起動しました
📁 提供ディレクトリ: /Users/hattaryoga/Desktop/kiro_サイト出し分け/Claude-Code-Communication/public
🌐 URL: http://localhost:8000
```

## 2. トラブルシューティングガイド

### よくある問題と解決方法

#### 問題1: ポート8000が既に使用されている

**症状**: `OSError: [Errno 48] Address already in use`

**解決方法**:
```bash
# 使用中のプロセスを確認
lsof -i :8000

# プロセスを停止（PIDは上記コマンドで確認）
kill [PID]

# サーバーを再起動
python3 start-server.py
```

#### 問題2: 静的ファイルが404エラーになる

**症状**: styles.css や app.js にアクセスできない

**原因**: サーバーが誤ったディレクトリから起動されている

**解決方法**:
```bash
# 現在のサーバーのプロセスIDを確認
lsof -i :8000

# 作業ディレクトリを確認
lsof -p [PID] | grep cwd

# 正しいディレクトリに移動してから再起動
cd /Users/hattaryoga/Desktop/kiro_サイト出し分け/Claude-Code-Communication
python3 start-server.py
```

#### 問題3: ページが表示されない

**確認項目**:
1. サーバーが起動しているか
2. publicディレクトリに必要なファイルがあるか
3. ブラウザのキャッシュをクリアする

```bash
# ファイルの存在確認
ls -la public/
# 必要なファイル: index.html, app.js, styles.css, data-manager.js
```

## 3. 監視設定の説明

### ヘルスチェック監視

30秒ごとにサーバーの稼働状況を確認する自動監視スクリプト：

```bash
# ヘルスチェック開始
nohup bash -c 'while true; do \
  curl -s http://localhost:8000 > /dev/null && \
  echo "[$(date +"%Y-%m-%d %H:%M:%S")] Health check: OK" || \
  echo "[$(date +"%Y-%m-%d %H:%M:%S")] Health check: FAILED"; \
  sleep 30; \
done' > ./logs/health_check.log 2>&1 &
```

### ログファイルの確認方法

```bash
# サーバーログの確認
tail -f ./logs/server.log

# ヘルスチェックログの確認
tail -f ./logs/health_check.log

# 送信ログの確認（エージェント間通信）
tail -f ./logs/send_log.txt
```

### パフォーマンス確認

```bash
# レスポンス時間の測定
curl -o /dev/null -s -w "Response time: %{time_total}s\n" http://localhost:8000

# 複数エンドポイントの一括確認
for region in 013 027 011; do
  echo -n "Region $region: "
  curl -o /dev/null -s -w "%{http_code} in %{time_total}s\n" \
    "http://localhost:8000/?region_id=$region"
done
```

## 4. 本番運用のベストプラクティス

### 起動時チェックリスト

- [ ] プロジェクトディレクトリで起動する
- [ ] ログディレクトリが存在することを確認
- [ ] 必要なデータファイルがpublic/data/に存在
- [ ] ポート8000が空いている

### 定期メンテナンス

1. **ログローテーション**（週1回推奨）
   ```bash
   # 古いログをアーカイブ
   mv ./logs/server.log ./logs/server.log.$(date +%Y%m%d)
   ```

2. **ヘルスチェック確認**（日次）
   ```bash
   # 最新のヘルスチェック結果
   tail -20 ./logs/health_check.log | grep FAILED
   ```

3. **パフォーマンス監視**（随時）
   ```bash
   # アクセス統計の確認
   grep "GET" ./logs/server.log | wc -l
   ```

### 緊急時の連絡先

- サーバー停止時：即座に再起動を実施
- データ更新が必要な場合：public/data/内のCSVファイルを更新

## 5. よく使うコマンド一覧

```bash
# サーバー起動
python3 start-server.py

# サーバー停止
kill $(lsof -t -i:8000)

# 状態確認
lsof -i :8000

# アクセステスト
curl http://localhost:8000

# ログ確認
tail -f ./logs/server.log
```

---

このドキュメントは運用の基本的な手順をカバーしています。
問題が発生した場合は、まずトラブルシューティングガイドを参照してください。