# CSV管理画面 統合ガイド

最終更新: 2025年7月17日

## 概要

Worker1のUI実装とWorker2のCSV処理ロジックが統合された管理画面システムです。

## システム構成

### Worker1提供コンポーネント
- **admin-script.js**: UI管理とイベント処理
- **admin-style.css**: スタイリング
- **index.html**: 管理画面HTML

### Worker2提供コンポーネント
- **csv-manager.js**: CSVパース・バリデーション処理
- **file-uploader.js**: ファイルアップロード処理
- **backup-manager.js**: バックアップ・復元機能
- **integration-adapter.js**: 統合アダプター

## 統合ポイント

### 1. ファイルサイズ制限
- Worker1: 10MB制限
- Worker2: 5MB制限
- **統合後**: 5MB（より厳しい制限を採用）

### 2. Papa Parseライブラリ
```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
```

### 3. データタイプマッピング
```javascript
const dataTypeMap = {
    'region': 'regions',      // Worker1 → Worker2
    'items': 'clinics',       // Worker1 → Worker2
    'ranking': 'rankings',    // Worker1 → Worker2
    'stores': 'stores',       // 同じ
    'store_view': 'store_views' // Worker1 → Worker2
};
```

## 機能統合

### CSV処理フロー
1. Worker1のUIでファイル選択/ドラッグ&ドロップ
2. Worker2のバリデーション実行
3. Papa ParseでCSV解析
4. 自動バックアップ作成
5. プレビュー表示
6. データ保存

### セキュリティ機能
- XSS対策（値のサニタイズ）
- ファイル型検証
- サイズ制限チェック
- CSVインジェクション防止

### バックアップ機能
- アップロード前の自動バックアップ
- ロールバック機能
- バックアップのエクスポート
- 最大10世代管理

## 使用方法

### 1. サーバー起動
```bash
cd /Users/hattaryoga/Desktop/kiro_サイト出し分け/Claude-Code-Communication
python3 start-server.py
```

### 2. 管理画面アクセス
```
http://localhost:8000/admin/
```

### 3. CSVファイルアップロード
1. 各カテゴリのドロップゾーンにCSVをドラッグ&ドロップ
2. またはクリックしてファイルを選択
3. プログレスバーで進捗確認
4. プレビューで内容確認

### 4. データ検証
「データ検証」ボタンをクリックして全ファイルの整合性をチェック

### 5. 保存
「保存」ボタンでデータを確定

## トラブルシューティング

### Papa Parseエラー
```
Papa Parse CDNの読み込みに失敗しました
```
→ ネットワーク接続を確認し、ページを再読み込み

### ファイルサイズエラー
```
ファイルサイズが大きすぎます（5MB以下にしてください）
```
→ CSVファイルを分割するか、不要な行を削除

### バリデーションエラー
```
必須列が不足しています: [列名]
```
→ CSVファイルのヘッダー行を確認

## テスト方法

### ブラウザコンソールでの統合テスト
```javascript
// 統合テスト実行
window.integrationAdapter.runIntegrationTest()

// ステータス確認
window.integrationAdapter.getStatus()

// 互換性テスト
const test = new CompatibilityTest();
await test.runAllTests();
```

## 既存システムとの互換性

✅ data-manager.jsと100%互換
- getAllRegions()
- getRegionById()
- getRankingByRegionId()
- getStoresByRegionId()
- 全メソッド動作確認済み

## 開発者向け情報

### ファイル追加時の注意
1. CSVスキーマをcsv-manager.jsに追加
2. データタイプマッピングを更新
3. UIにアップロードカードを追加

### カスタマイズポイント
- バックアップ保持数: backup-manager.js の maxBackups
- ファイルサイズ制限: csv-manager.js の maxFileSize
- バリデーションルール: csv-manager.js の validateDataTypes

## 今後の拡張予定
- サーバーサイドAPI統合
- リアルタイムプレビュー更新
- 差分アップロード機能
- 自動データ同期