# セキュリティ・ベストプラクティスチェックリスト

最終更新日: 2025年7月17日

## 1. セキュリティチェック

### 現状の評価と推奨事項

#### ✅ XSS（クロスサイトスクリプティング）対策

**現状**: 
- HTMLへの動的な値の挿入時にtextContentを使用（安全）
- innerHTMLの使用は最小限

**推奨事項**:
```javascript
// 安全な実装例（現在の実装）
element.textContent = userInput;  // ✅ 推奨

// 危険な実装例（避けるべき）
element.innerHTML = userInput;     // ❌ 危険
```

**追加対策**:
```python
# start-server.pyに追加するセキュリティヘッダー
def end_headers(self):
    self.send_header('X-Content-Type-Options', 'nosniff')
    self.send_header('X-Frame-Options', 'DENY')
    self.send_header('X-XSS-Protection', '1; mode=block')
    super().end_headers()
```

#### ⚠️ CSRF（クロスサイトリクエストフォージェリ）対策

**現状**: 読み取り専用サイトのため、現時点では不要

**将来の考慮事項**:
- データ更新機能を追加する場合は、CSRFトークンの実装が必須
- フォーム送信時のトークン検証

#### ⚠️ Content Security Policy (CSP)

**現状**: 未設定

**推奨設定**:
```python
# start-server.pyに追加
self.send_header('Content-Security-Policy', 
    "default-src 'self'; " +
    "script-src 'self'; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "font-src 'self';")
```

## 2. パフォーマンス最適化

### 静的ファイルのキャッシュ設定

**推奨設定**:
```python
# start-server.pyに追加
def end_headers(self):
    # 静的ファイルのキャッシュ設定
    if self.path.endswith(('.js', '.css', '.jpg', '.png')):
        self.send_header('Cache-Control', 'public, max-age=31536000')
    elif self.path.endswith('.html'):
        self.send_header('Cache-Control', 'no-cache, no-store, must-revalidate')
    super().end_headers()
```

### gzip圧縮の推奨設定

**本番環境での推奨**:
- Nginx/Apacheでの圧縮設定
- CloudFrontやCloudflareでの自動圧縮

**Nginx設定例**:
```nginx
gzip on;
gzip_types text/plain text/css application/json application/javascript;
gzip_min_length 1000;
```

### CDN利用の検討

**推奨事項**:
- 静的ファイル（CSS, JS, 画像）のCDN配信
- 地理的に分散したユーザーへの高速配信
- DDoS攻撃への耐性向上

## 3. 本番環境向け推奨事項

### 🔴 HTTPS必須

**理由**:
- データの暗号化
- SEO向上
- ブラウザの警告回避

**実装方法**:
1. Let's Encryptで無料SSL証明書取得
2. リバースプロキシ（Nginx）でHTTPS終端
3. HTTP→HTTPSリダイレクト設定

### ログローテーション設定

**推奨設定（logrotate）**:
```bash
# /etc/logrotate.d/clinic-ranking
/path/to/logs/*.log {
    daily
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        # サーバー再起動不要
    endscript
}
```

### バックアップ戦略

**推奨バックアップ計画**:

1. **データファイル（日次）**
   ```bash
   # cronでの自動バックアップ
   0 2 * * * tar -czf /backup/data-$(date +\%Y\%m\%d).tar.gz /path/to/public/data/
   ```

2. **設定ファイル（週次）**
   ```bash
   0 3 * * 0 tar -czf /backup/config-$(date +\%Y\%m\%d).tar.gz *.py *.md *.sh
   ```

3. **保持期間**
   - データ: 30日
   - 設定: 90日

## 4. 実装優先度チェックリスト

### 🔴 即座に実装すべき項目

- [ ] HTTPS化（本番環境）
- [ ] セキュリティヘッダーの追加
- [ ] ログローテーション設定

### 🟡 早期に実装すべき項目

- [ ] CSP（Content Security Policy）設定
- [ ] 静的ファイルのキャッシュ設定
- [ ] 自動バックアップスクリプト

### 🟢 将来的に検討すべき項目

- [ ] CDN導入
- [ ] gzip圧縮（大規模化時）
- [ ] WAF（Web Application Firewall）導入

## 5. セキュリティ監査スクリプト

```bash
#!/bin/bash
# security-check.sh

echo "=== セキュリティ監査 ==="

# HTTPSチェック
if curl -s -I https://localhost:8000 > /dev/null 2>&1; then
    echo "✅ HTTPS: 有効"
else
    echo "❌ HTTPS: 無効（要対応）"
fi

# セキュリティヘッダーチェック
headers=$(curl -s -I http://localhost:8000)
for header in "X-Content-Type-Options" "X-Frame-Options" "X-XSS-Protection"; do
    if echo "$headers" | grep -q "$header"; then
        echo "✅ $header: 設定済み"
    else
        echo "❌ $header: 未設定"
    fi
done

# ファイル権限チェック
if [ -w "public/data" ]; then
    echo "⚠️  データディレクトリが書き込み可能"
fi
```

## 6. インシデント対応手順

1. **異常検知時**
   - ログ確認: `tail -100 ./logs/server.log`
   - プロセス確認: `ps aux | grep python`
   - ポート確認: `netstat -tlnp | grep 8000`

2. **攻撃検知時**
   - 即座にサーバー停止
   - ログ保全
   - 原因調査

3. **復旧手順**
   - バックアップから復元
   - セキュリティパッチ適用
   - 監視強化

---

このチェックリストは定期的に見直し、最新のセキュリティベストプラクティスに準拠するよう更新してください。